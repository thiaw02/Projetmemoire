<!DOCTYPE html>
<html>
<head>
    <title>Test Déconnexion Patient</title>
    <meta name="csrf-token" content="test-token">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h2>Test de Déconnexion Patient</h2>
        <div class="alert alert-info">
            <h5>Instructions :</h5>
            <ol>
                <li>Connectez-vous en tant que patient</li>
                <li>Allez sur le dashboard patient</li>
                <li>Testez la déconnexion avec le bouton en haut à droite</li>
                <li>Ouvrez la console développeur (F12) pour voir les logs</li>
            </ol>
        </div>
        
        <div class="alert alert-info">
            <h5>Problème résolu :</h5>
            <p>La déconnexion depuis le dashboard patient générait une erreur 419 "Page Expired". Le bouton de la navbar principale a été corrigé pour rafraîchir automatiquement le token CSRF avant la déconnexion.</p>
        </div>
        
        <div class="alert alert-success">
            <h5>Solutions implémentées :</h5>
            <ul>
                <li>✅ Bouton de déconnexion navbar corrigé avec fonction robuste</li>
                <li>✅ Fonction de rafraîchissement automatique du token CSRF globale</li>
                <li>✅ API endpoint pour récupérer un nouveau token CSRF (/csrf-token)</li>
                <li>✅ Diagnostic et logs pour identifier les problèmes</li>
                <li>✅ Rafraîchissement périodique du token (toutes les 10 minutes pour les patients)</li>
                <li>✅ Gestion des erreurs 419/401 avec redirections appropriées</li>
                <li>✅ Formulaire de déconnexion dynamique créé avec token frais</li>
            </ul>
        </div>
        
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Test Rapide</h5>
                <p>Testez l'API de récupération du token CSRF :</p>
                <button class="btn btn-primary" onclick="testCSRF()">Tester CSRF Token</button>
                <div id="result" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        async function testCSRF() {
            const resultDiv = document.getElementById('result');
            try {
                const response = await fetch('/csrf-token', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `<div class="alert alert-success">
                        <strong>Succès !</strong> Token reçu : ${data.token.substring(0, 20)}...
                    </div>`;
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">
                        <strong>Erreur !</strong> Status: ${response.status}
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">
                    <strong>Erreur !</strong> ${error.message}
                </div>`;
            }
        }
    </script>
</body>
</html>