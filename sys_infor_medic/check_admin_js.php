<?php
/**
 * Script de v√©rification avanc√©e des fonctionnalit√©s JavaScript et interactions admin
 */

echo "üîç V√âRIFICATION AVANC√âE DES FONCTIONNALIT√âS ADMIN\n";
echo "=================================================\n\n";

$js_functions_to_check = [
    'initializeCharts' => 'Initialisation des graphiques',
    'initRolesChart' => 'Graphique des r√¥les', 
    'initRendezVousChart' => 'Graphique des rendez-vous',
    'initMonthlyCharts' => 'Graphiques mensuels',
    'updatePayment' => 'Mise √† jour des paiements (si pr√©sent)',
];

$critical_elements = [
    '#adminTab' => 'Onglets admin',
    '.admin-tabs' => 'Navigation par onglets',
    '#usersTable' => 'Tableau des utilisateurs',
    '#patientsTable' => 'Tableau des patients',
    '#roleUpdateModal' => 'Modal de mise √† jour des r√¥les',
    '.js-open-role-modal' => 'Boutons d\'ouverture modal r√¥le',
    '.nav-link' => 'Liens de navigation',
    '.btn' => 'Boutons interactifs',
];

$form_validations = [
    'required fields validation' => 'Validation des champs obligatoires',
    'email validation' => 'Validation des emails',
    'password confirmation' => 'Confirmation de mot de passe',
    'role selection' => 'S√©lection de r√¥le',
];

$errors = [];
$warnings = [];
$success = [];

// 1. V√©rifier la pr√©sence de Chart.js et Bootstrap
echo "üìä 1. V√âRIFICATION DES D√âPENDANCES\n";
echo "----------------------------------\n";

$dashboard_content = '';
if (file_exists(__DIR__ . '/resources/views/admin/dashboard.blade.php')) {
    $dashboard_content = file_get_contents(__DIR__ . '/resources/views/admin/dashboard.blade.php');
    
    if (strpos($dashboard_content, 'chart.js') !== false) {
        echo "‚úÖ Chart.js d√©tect√©\n";
        $success[] = "Chart.js pr√©sent";
    } else {
        echo "‚ö†Ô∏è  Chart.js non d√©tect√© - V√©rifier l'inclusion\n";
        $warnings[] = "Chart.js potentiellement manquant";
    }
    
    if (strpos($dashboard_content, 'bootstrap') !== false || strpos($dashboard_content, 'data-bs-') !== false) {
        echo "‚úÖ Bootstrap 5 d√©tect√©\n";
        $success[] = "Bootstrap 5 pr√©sent";
    } else {
        echo "‚ö†Ô∏è  Bootstrap 5 non d√©tect√© clairement\n";
        $warnings[] = "Bootstrap 5 √† v√©rifier";
    }
} else {
    $errors[] = "Dashboard admin non trouv√©";
    echo "‚ùå Dashboard admin non trouv√©\n";
}

echo "\n";

// 2. V√©rifier les fonctions JavaScript critiques
echo "‚ö° 2. V√âRIFICATION DES FONCTIONS JAVASCRIPT\n";
echo "------------------------------------------\n";

if (!empty($dashboard_content)) {
    foreach ($js_functions_to_check as $function => $description) {
        if (strpos($dashboard_content, $function) !== false) {
            echo "‚úÖ {$description} - {$function}\n";
            $success[] = "Fonction JS: {$function}";
        } else {
            echo "‚ö†Ô∏è  {$description} - {$function} NON TROUV√âE\n";
            $warnings[] = "Fonction JS manquante: {$function}";
        }
    }
} else {
    echo "‚ùå Impossible de v√©rifier les fonctions JS\n";
    $errors[] = "Contenu dashboard non disponible pour v√©rification JS";
}

echo "\n";

// 3. V√©rifier les √©l√©ments DOM critiques
echo "üéØ 3. V√âRIFICATION DES √âL√âMENTS DOM\n";
echo "-----------------------------------\n";

if (!empty($dashboard_content)) {
    foreach ($critical_elements as $selector => $description) {
        $search_pattern = str_replace(['#', '.'], ['id="', 'class="'], $selector);
        if (strpos($dashboard_content, $search_pattern) !== false) {
            echo "‚úÖ {$description} - {$selector}\n";
            $success[] = "√âl√©ment DOM: {$selector}";
        } else {
            // Essayer une recherche alternative
            $alt_pattern = str_replace(['"'], [''], $search_pattern);
            if (strpos($dashboard_content, $alt_pattern) !== false) {
                echo "‚úÖ {$description} - {$selector} (trouv√© avec pattern alternatif)\n";
                $success[] = "√âl√©ment DOM: {$selector}";
            } else {
                echo "‚ö†Ô∏è  {$description} - {$selector} NON TROUV√â\n";
                $warnings[] = "√âl√©ment DOM manquant: {$selector}";
            }
        }
    }
} else {
    echo "‚ùå Impossible de v√©rifier les √©l√©ments DOM\n";
    $errors[] = "Contenu dashboard non disponible pour v√©rification DOM";
}

echo "\n";

// 4. V√©rifier les √©v√©nements et interactions
echo "üîÑ 4. V√âRIFICATION DES √âV√âNEMENTS ET INTERACTIONS\n";
echo "------------------------------------------------\n";

$event_patterns = [
    'addEventListener' => 'Gestionnaires d\'√©v√©nements',
    'data-bs-toggle' => 'Interactions Bootstrap',
    'onclick' => 'Gestionnaires de clic',
    'onsubmit' => 'Gestionnaires de soumission',
    'data-filter' => 'Filtres interactifs',
];

if (!empty($dashboard_content)) {
    foreach ($event_patterns as $pattern => $description) {
        if (strpos($dashboard_content, $pattern) !== false) {
            echo "‚úÖ {$description}\n";
            $success[] = "√âv√©nement: {$pattern}";
        } else {
            echo "‚ö†Ô∏è  {$description} - Pattern '{$pattern}' non trouv√©\n";
            $warnings[] = "√âv√©nement manquant: {$pattern}";
        }
    }
} else {
    echo "‚ùå Impossible de v√©rifier les √©v√©nements\n";
    $errors[] = "Contenu dashboard non disponible pour v√©rification √©v√©nements";
}

echo "\n";

// 5. V√©rifier les formulaires et validations
echo "üìã 5. V√âRIFICATION DES FORMULAIRES\n";
echo "----------------------------------\n";

$form_files = [
    'resources/views/admin/users/create.blade.php',
    'resources/views/admin/users/edit.blade.php', 
    'resources/views/admin/patients/create.blade.php',
    'resources/views/admin/patients/edit.blade.php',
];

foreach ($form_files as $form_file) {
    if (file_exists(__DIR__ . '/' . $form_file)) {
        $form_content = file_get_contents(__DIR__ . '/' . $form_file);
        
        echo "üìù V√©rification: " . basename($form_file) . "\n";
        
        // V√©rifier la pr√©sence de validation HTML5
        if (strpos($form_content, 'required') !== false) {
            echo "  ‚úÖ Validation HTML5 (required)\n";
        } else {
            echo "  ‚ö†Ô∏è  Validation HTML5 manquante\n";
            $warnings[] = "Validation HTML5 manquante dans " . basename($form_file);
        }
        
        // V√©rifier les tokens CSRF
        if (strpos($form_content, '@csrf') !== false || strpos($form_content, 'csrf_token') !== false) {
            echo "  ‚úÖ Protection CSRF\n";
        } else {
            echo "  ‚ùå Protection CSRF manquante\n";
            $errors[] = "Protection CSRF manquante dans " . basename($form_file);
        }
        
        // V√©rifier les m√©thodes HTTP appropri√©es
        if (strpos($form_content, '@method') !== false || strpos($form_content, 'method="POST"') !== false) {
            echo "  ‚úÖ M√©thodes HTTP correctes\n";
        } else {
            echo "  ‚ö†Ô∏è  M√©thodes HTTP √† v√©rifier\n";
            $warnings[] = "M√©thodes HTTP √† v√©rifier dans " . basename($form_file);
        }
        
        echo "\n";
    } else {
        echo "‚ùå Fichier manquant: " . basename($form_file) . "\n";
        $errors[] = "Fichier manquant: " . basename($form_file);
    }
}

// 6. R√©sum√© et recommandations
echo "üìä R√âSUM√â DE LA V√âRIFICATION AVANC√âE\n";
echo "====================================\n";

echo "‚úÖ Succ√®s: " . count($success) . "\n";
echo "‚ö†Ô∏è  Avertissements: " . count($warnings) . "\n";
echo "‚ùå Erreurs: " . count($errors) . "\n\n";

if (!empty($errors)) {
    echo "üö® ERREURS CRITIQUES:\n";
    foreach ($errors as $error) {
        echo "   ‚ùå {$error}\n";
    }
    echo "\n";
}

if (!empty($warnings)) {
    echo "‚ö†Ô∏è  POINTS D'ATTENTION:\n";
    foreach ($warnings as $warning) {
        echo "   ‚ö†Ô∏è  {$warning}\n";
    }
    echo "\n";
}

// 7. Plan de test manuel
echo "üß™ PLAN DE TEST MANUEL D√âTAILL√â\n";
echo "===============================\n";

echo "1. üîê CONNEXION ET ACC√àS:\n";
echo "   - Se connecter avec un compte admin\n";
echo "   - V√©rifier la redirection vers /admin/dashboard\n";
echo "   - Confirmer l'affichage du header admin\n\n";

echo "2. üóÇÔ∏è NAVIGATION DANS LES ONGLETS:\n";
echo "   - Cliquer sur chaque onglet du dashboard\n";
echo "   - V√©rifier que le contenu change\n";
echo "   - Confirmer que l'onglet actif est bien mis en surbrillance\n\n";

echo "3. üìä GRAPHIQUES ET STATISTIQUES:\n";
echo "   - V√©rifier que les graphiques s'affichent\n";
echo "   - Tester les boutons de p√©riode (2 mois, 6 mois, 1 an)\n";
echo "   - Confirmer que les KPI affichent des valeurs\n\n";

echo "4. üë• GESTION DES UTILISATEURS:\n";
echo "   - Aller dans l'onglet 'G√©rer utilisateurs'\n";
echo "   - Tester la recherche en tapant dans le champ\n";
echo "   - Cliquer sur 'Liste avanc√©e' ‚Üí v√©rifier la redirection\n";
echo "   - Tester les boutons Modifier/Supprimer\n";
echo "   - Essayer de changer le statut Actif/Inactif\n\n";

echo "5. üè• GESTION DES PATIENTS:\n";
echo "   - Aller dans l'onglet 'G√©rer patients'\n";
echo "   - Tester les boutons d'action\n";
echo "   - V√©rifier le bouton 'Ajouter un patient'\n\n";

echo "6. üîß GESTION DES R√îLES:\n";
echo "   - Aller dans l'onglet 'Superviser r√¥les'\n";
echo "   - Tester les filtres de recherche\n";
echo "   - Cliquer sur un bouton de changement de r√¥le\n";
echo "   - V√©rifier que le modal s'ouvre\n";
echo "   - Tester la soumission du formulaire de r√¥le\n\n";

echo "7. üîê GESTION DES PERMISSIONS:\n";
echo "   - Aller dans l'onglet 'Gestion r√¥les & permissions'\n";
echo "   - Tester les boutons de niveau (Aucun/Lecture/Complet)\n";
echo "   - Cliquer sur 'Enregistrer les Permissions'\n";
echo "   - V√©rifier les messages de confirmation\n\n";

echo "8. üí≥ GESTION DES PAIEMENTS:\n";
echo "   - Aller dans l'onglet 'Paiements'\n";
echo "   - V√©rifier les KPI de revenus\n";
echo "   - Tester les filtres de transactions\n";
echo "   - V√©rifier les boutons d'action sur les paiements\n\n";

echo "9. üì± RESPONSIVE ET MOBILIT√â:\n";
echo "   - R√©duire la taille de la fen√™tre\n";
echo "   - V√©rifier que les onglets deviennent scrollables\n";
echo "   - Confirmer que les tableaux restent lisibles\n";
echo "   - Tester sur mobile si possible\n\n";

echo "10. üîÑ INTERACTIONS ET FEEDBACK:\n";
echo "    - V√©rifier que les boutons changent au survol\n";
echo "    - Confirmer les messages de succ√®s/erreur\n";
echo "    - Tester les confirmations de suppression\n";
echo "    - V√©rifier les tooltips et les badges\n\n";

// Note sur la performance
echo "‚ö° NOTE SUR LA PERFORMANCE:\n";
echo "==========================\n";
echo "Si vous constatez des lenteurs:\n";
echo "1. Ouvrir les outils de d√©veloppement (F12)\n";
echo "2. Aller dans l'onglet Console\n";
echo "3. Chercher des erreurs JavaScript en rouge\n";
echo "4. Aller dans l'onglet Network pour voir les requ√™tes lentes\n";
echo "5. V√©rifier que Chart.js se charge correctement\n\n";

// Retourner le code d'√©tat
if (count($errors) > 0) {
    echo "üî¥ R√âSULTAT: Des erreurs critiques ont √©t√© d√©tect√©es\n";
    exit(1);
} elseif (count($warnings) > 5) {
    echo "üü° R√âSULTAT: Beaucoup d'avertissements - √Ä v√©rifier\n";
    exit(1);
} else {
    echo "üü¢ R√âSULTAT: L'interface admin semble fonctionnelle\n";
    echo "Proc√©dez aux tests manuels pour confirmer le bon fonctionnement.\n";
    exit(0);
}
?>